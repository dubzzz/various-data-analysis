<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Battle for riddler</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="algorithms.js"></script>
    <script src="battle-for-riddler.js"></script>
    <script src="dataset.js"></script>
  </head>
  <body>
    <div id="castles"></div>
    <div id="actions">
      <div>
        <h2>Generate based on...</h2>
        <button type="button" id="generate">Panel trainer</button>
        <button type="button" id="generate_minimizer">Minimize risk trainer</button>
        <button type="button" id="generate_self_trained">Self-trained trainer</button>
        <br/>
        <input type="checkbox" id="switch_generator" /> Checked = &lt;Genetic algorithm&gt;, Unchecked = &lt;Gradient descent&gt;
      </div>
      <div>
        <h2>Running battle against...</h2>
        <button type="button" id="evaluate_contest">Contest members</button>
        <button type="button" id="evaluate_random100">0.1k randoms</button>
        <button type="button" id="evaluate_random1000">1k randoms</button>
        <button type="button" id="evaluate_random10000">10k randoms</button>
      </div>
    </div>

    <script type="text/javascript">
      var NUM_FIELDS = 10;

      var $fields = $("#castles");
      for (var idx = 0 ; idx != NUM_FIELDS ; ++idx) {
        var $f = $("<input/>");
        $f.attr("id", "castle" + idx);
        $f.attr("type", "number");
        $f.attr("step", "8");
        $f.attr("value", "0");
        $f.attr("min", "0");
        $f.attr("max", "100");
        $fields.append($f);
      }
      $("#generate").text($("#generate").text() + " (" + NUM_PANEL_STRATEGIES + " members)")

      function generate_with_trainer(trainer) {
        var suggestion = $("#switch_generator").is(":checked")
            ? suggest_strategy_retry(10, trainer)
            : suggest_strategy_descent(trainer);
        for (var i = 0 ; i != NUM_FIELDS ; ++i) {
          $("#castle" + i).val(suggestion[i]);
        }
      }

      function read_user_input() {
        var suggestion = [];
        for (var i = 0 ; i != NUM_FIELDS ; ++i) {
          suggestion.push(+$("#castle" + i).val());
        }
        return suggestion;
      }

      $("#generate").click(function() {
          generate_with_trainer(make_panel_trainer());
      });
      $("#generate_minimizer").click(function() {
          generate_with_trainer(make_minimizer_trainer(STRATEGY_POPULATION, STRATEGY_SIZE));
      });
      $("#generate_self_trained").click(function() {
          generate_with_trainer(make_self_trained_trainer());
      });

      function evaluate_against(comparison_dataset) {
        var suggestion = read_user_input();
        var minimize_score = make_minimizer_trainer(STRATEGY_POPULATION, STRATEGY_SIZE)(suggestion);
        var score = accumulate(comparison_dataset, 0, (acc, s) => acc + score_battle(suggestion, s)[0]);
        var summary = accumulate(comparison_dataset, [0,0,0], (acc, s) => { ++acc[run_battle(suggestion, s)]; return acc;});

        comparison_dataset.push(suggestion);
        var scores = generate_n(comparison_dataset.length, () => 0);
        for (var i = 0 ; i != comparison_dataset.length -1 ; ++i) {
          for (var j = i+1 ; j != comparison_dataset.length ; ++j) {
            var s = score_battle(comparison_dataset[i], comparison_dataset[j]);
            scores[i] += s[0];
            scores[j] += s[1];
          }
        }
        comparison_dataset = sorted_against(comparison_dataset, scores, (a,b) => b-a);
        var ranking = comparison_dataset.indexOf(suggestion) +1; //search by pointer

        alert("Minimize risk trainer: " + Number(minimize_score).toFixed(2) + "\n"
            + "Score in the contest: " + score + " (" + summary[1] + " wins, " + summary[0] + " nuls, " + summary[2] + " defeats)\n"
            + "Rank: " + ranking + " over " + comparison_dataset.length);
      }

      $("#evaluate_contest").click(function() {
          evaluate_against(dataset.slice());
      });
      $("#evaluate_random100").click(function() {
          evaluate_against(generate_strategies(100));
      });
      $("#evaluate_random1000").click(function() {
          evaluate_against(generate_strategies(1000));
      });
      $("#evaluate_random10000").click(function() {
          evaluate_against(generate_strategies(10000));
      });
    </script>
  </body>
</html>
